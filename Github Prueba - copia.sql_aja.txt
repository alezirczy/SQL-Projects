CREATE EXTENSION IF NOT EXISTS tablefunc;

SELECT *
FROM crosstab(
    $$ 


	WITH home AS(	

		SELECT c.name,t.team_long_name, home_goal, away_goal, season,	

			sum(CASE WHEN home_goal>away_goal THEN 3
					WHEN home_goal<away_goal THEN 0
					ELSE 1 END) AS scores	

		FROM match as m

		LEFT JOIN team as t 

		ON m.hometeam_id=t.team_api_id --OR m.awayteam_id=t.team_api_id 

		LEFT JOIN country as c 
		ON m.country_id=c.id

		--WHERE  c.id=21518 AND t.team_api_id=8634--AND stage=38 
	    
		group by c.name,t.team_long_name, home_goal, away_goal,season
 
     ),

	 
     away AS(	

		SELECT c.name,t.team_long_name, home_goal, away_goal, season,	

			sum(CASE WHEN home_goal<away_goal THEN 3
					WHEN home_goal>away_goal THEN 0
					ELSE 1 END) AS scores	

		FROM match as m

		LEFT JOIN team as t 

		ON  m.awayteam_id=t.team_api_id 

		LEFT JOIN country as c 
		ON m.country_id=c.id

		--WHERE  c.id=21518 AND t.team_api_id=8634--AND stage=38 
	    
		group by c.name,t.team_long_name, home_goal, away_goal,season
 
     ),


     uniendo AS  (SELECT 	home.name,
				home.team_long_name,
				--home.stage,
				home.season,
				sum(home.scores) as puntos
					
			    FROM home
				
				GROUP BY
							home.name,
							home.team_long_name,
							--home.stage,
							home.season
				UNION

				SELECT 	away.name,
						away.team_long_name,
						--away.stage,
						away.season,
						sum(away.scores) 
					
				FROM away
				GROUP BY	away.name,
						    away.team_long_name,
							--away.stage,
							away.season),


resumiendo as  (select  uniendo.name,uniendo.team_long_name,uniendo.season, sum(puntos) as puntos

				FROM uniendo
				

				group by  uniendo.name,uniendo.team_long_name,uniendo.season
				ORDER BY uniendo.season,puntos DESC)











SELECT
            resumiendo.name,
            resumiendo.team_long_name,
            resumiendo.season,
			resumiendo.puntos AS value,
            RANK() OVER (PARTITION BY resumiendo.name, resumiendo.season ORDER BY resumiendo.puntos DESC, resumiendo.season DESC) AS rank
        
            
        FROM
            resumiendo
 --       WHERE
   --         resumiendo.name = 'Spain'
    $$,
    $$
        VALUES ('2011/2012'::text), ('2012/2013'::text), ('2013/2014'::text), ('2014/2015'::text)
    $$
) AS ct(rowid int, name text, team_long_name text, season text, rank int, "2011/2012" bigint, "2012/2013" bigint, "2013/2014" bigint, "2014/2015" bigint);
